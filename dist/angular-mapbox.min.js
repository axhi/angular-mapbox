angular.module("angular-mapbox",[]).service("mapboxService",["$timeout","$http",function(e,a){function o(e){this.opts=e||{},L.mapbox.accessToken=e.accessToken}function n(e,o,n,t,r,i){t=_.extend({access_token:r},t),a({method:"GET",url:"https://api.mapbox.com/"+e+"/v5/"+o+"/"+n+".json",params:t}).then(function(e){i(e)},function(e){i(e)})}function t(e,a){n("geocoding","mapbox.places",e,"autocomplete=true",this.opts.accessToken,function(e){a(e.data)})}function r(e,a,o){a=a||{},this.mapInstances[i(e)]={map:e,options:a,markers:o}}function i(e){return e._container.id}function s(e){delete this.mapInstances[i(e)]}function c(){return this.mapInstances}function l(e){return this.mapInstances[e].map}function p(e){if(this.mapInstances[i(e)])return this.mapInstances[i(e)].markers}function u(e){if(this.mapInstances[i(e)])return this.mapInstances[i(e)].options}function m(a,o){e(function(){var e=new L.featureGroup(o);a.fitBounds(e.getBounds()),a.getZoom()>15&&a.setZoom(15)}.bind(this),200)}function d(e,a){var o=this.mapInstances[i(e)],n=o.markers,t=o.options;n.push(a),this.mapInstances[i(e)].markers=n,t.scaleToFit&&this.fitMapToMarkers(e,n)}function f(e,a){var o,n=this.getMarkersForMap(e);if(n){var t=this.getOptionsForMap(e),r=t.clusterGroup;if(t.clusterMarkers)return void r.removeLayer(a);e.removeLayer(a);for(var s=0;n[s];s++)n[s]._leaflet_id===a._leaflet_id&&(o=s);n.splice(o,1),t.scaleToFit&&t.scaleToFitAll&&this.fitMapToMarkers(e,n),this.mapInstances[i(e)].markers=n}}function v(e,a,o){this.clearCircles(e);var n=L.circle(a,o);this.opts.layer=n,n.addTo(e)}function g(e){this.opts.layer&&e.removeLayer(this.opts.layer)}function k(e,a,o){e.setView(a,o)}var h={},b={};return{init:o,getMapInstances:c,addMapInstance:r,removeMapInstance:s,getMarkersForMap:p,addMarker:d,removeMarker:f,fitMapToMarkers:m,getOptionsForMap:u,getMapInstance:l,mapInstances:h,drawCircle:v,geocode:t,opts:b,setView:k,clearCircles:g}}]).directive("mapbox",["$timeout","mapboxService",function(e,a){return{restrict:"E",transclude:!0,scope:{onReposition:"&?",onZoom:"&?",onClick:"&?"},replace:!0,template:'<div class="angular-mapbox-map" ng-transclude></div>',link:function(o,n,t){var r=n[0];r.id=t.id,o.map=L.mapbox.map(r,t.mapId),o.markers=[],o.featureLayers=[];var i={clusterMarkers:void 0!==t.clusterMarkers,scaleToFit:void 0!==t.scaleToFit,scaleToFitAll:"all"===t.scaleToFit};if(void 0!==i.clusterMarkers&&(i.clusterGroup=new L.MarkerClusterGroup({disableClusteringAtZoom:18,removeOutsideVisibleBounds:!0,showCoverageOnHover:!1}),o.map.featureLayer.on("ready",function(e){e.target.eachLayer(function(e){i.clusterGroup.addLayer(e)})}),o.map.addLayer(i.clusterGroup)),a.addMapInstance(o.map,i,o.markers),"false"===t.dragging&&o.map.dragging.disable(),"false"===t.touchZoom&&o.map.touchZoom.disable(),"false"===t.doubleClickZoom&&o.map.doubleClickZoom.disable(),"false"===t.scrollWheelZoom&&o.map.scrollWheelZoom.disable(),void 0===t.autoSize){var s=t.width||"100",c=t.height||500;isNaN(s)?n.css("width",s):n.css("width",s+"%"),isNaN(c)?n.css("height",c):n.css("height",c+"px")}o.onReposition&&o.map.on("dragend",function(a){e(function(){o.onReposition({event:a,map:o.map})})}),o.onZoom&&o.map.on("zoomend",function(a){e(function(){o.onZoom({event:a,map:o.map})})}),o.onClick&&o.map.on("click",function(a){e(function(){o.onClick({event:a,map:o.map})})});var l=function(){var e=t.zoom||12;t.lat&&t.lng?o.map.setView([t.lat,t.lng],e):o.map.setZoom(e)};t.$observe("lat",l),t.$observe("lng",l),t.$observe("zoom",l),n.bind("$destroy",function(){a.removeMapInstance(o.map),o.map.remove()}),l()}}}]).directive("marker",["mapboxService",function(e){return{restrict:"E",scope:{onClick:"&",marker:"="},link:function(a,o,n){function t(e){return e.iconUrl?L.icon({iconUrl:e.iconUrl,iconSize:e.iconSize.split(","),iconAnchor:[20,30]}):L.icon()}function r(a,o,n,t){t=t||{};var r=L.marker(n,t);return e.getOptionsForMap(o).clusterMarkers&&t.excludeFromClustering!==!0?e.getOptionsForMap(o).clusterGroup.addLayer(r):r.addTo(o),t.draggable&&r.dragging.enable(),t.clickable&&(r.options.clickable=!1),e.addMarker(o,r),r}var i,s;s={draggable:void 0!==n.draggable,clickable:void 0!==n.clickable,icon:t(n),bounceOnAdd:void 0!==n.bounce,bounceOnAddOptions:{duration:600,height:-.5}};var c=e.getMapInstance(n.id);i=r(a,c,[n.lat,n.lng],s),a.onClick&&i.on("click",function(){a.onClick({marker:a.marker})}),o.bind("$destroy",function(){e.getOptionsForMap(c)&&e.getOptionsForMap(c).clusterMarkers?e.getOptionsForMap(c).clusterGroup.removeLayer(i):e.removeMarker(c,i)})}}}]);